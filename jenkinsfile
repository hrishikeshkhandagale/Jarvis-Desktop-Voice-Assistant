pipeline {
    agent any

    environment {
        SSH_CRED    = 'python'
        SERVER_IP   = '52.66.240.126'
        REMOTE_USER = 'ubuntu'
        APP_DIR     = '/opt/jarvis'
        REPO_URL    = 'https://github.com/hrishikeshkhandagale/Jarvis-Desktop-Voice-Assistant.git'
    }

    stages {

        stage('Deploy Flask App') {
            steps {
                sshagent(credentials: ["${SSH_CRED}"]) {

                    sh '''
echo "=== 1. Create App Directory ==="
ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "\
    sudo mkdir -p ${APP_DIR}; sudo chown ubuntu:ubuntu ${APP_DIR} -R"


echo "=== 2. Clone or Update Repo ==="
ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "\
    if [ ! -d ${APP_DIR}/.git ]; then \
        git clone ${REPO_URL} ${APP_DIR}; \
    else \
        cd ${APP_DIR} && git pull; \
    fi"


echo "=== 3. Install Python & Flask ==="
ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "\
    sudo apt-get update -y && \
    sudo apt-get install -y python3 python3-pip && \
    pip3 install --break-system-packages -r ${APP_DIR}/requirements.txt || true"


echo "=== 4. Create Systemd Service for Flask ==="
ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "\
sudo bash -c 'cat > /etc/systemd/system/flaskapp.service <<EOF
[Unit]
Description=Flask Application
After=network.target

[Service]
WorkingDirectory=${APP_DIR}
ExecStart=/usr/bin/python3 ${APP_DIR}/app.py
Restart=always
User=ubuntu
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF'
"


echo "=== 5. Restart Flask Service ==="
ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "\
    sudo systemctl daemon-reload && \
    sudo systemctl enable flaskapp && \
    sudo systemctl restart flaskapp && \
    sudo systemctl status flaskapp --no-pager"
'''
                }
            }
        }
    }

    post {
        success { echo "✔ Flask Deployment Successful! Visit: http://${SERVER_IP}:5000" }
        failure { echo "❌ Deployment Failed!" }
    }
}
